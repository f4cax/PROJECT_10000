import React, { useState, useEffect, useCallback } from 'react';
import BudgetChart from '../components/charts/BudgetChart';
import BudgetRuleCard from '../components/forms/BudgetRuleCard';
import IncomeForm from '../components/forms/IncomeForm';
import NotificationCard from '../components/common/NotificationCard';
import FinancialStrategyCard from '../components/forms/FinancialStrategyCard';
import SavingsGoalCard from '../components/forms/SavingsGoalCard';
import { useTranslation } from '../utils/translations';
import { useAuth } from '../contexts/AuthContext';

export default function HomePage() {
  const { t } = useTranslation();
  const { saveMonthlyIncome, saveStrategy, isAuthenticated, user } = useAuth();
  const [monthlyIncome, setMonthlyIncome] = useState(0);
  const [budgetDistribution, setBudgetDistribution] = useState({
    needs: 0,        // 50% - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
    safety: 0,       // 25% - –ü–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏  
    investments: 0,  // 15% - –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
    wants: 0         // 10% - –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –∂–µ–ª–∞–Ω–∏—è
  });
  const [notifications, setNotifications] = useState([]);
  const [selectedStrategy, setSelectedStrategy] = useState(null);
  
  // –ú–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
  const handleStrategyChange = useCallback((newStrategy) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if (!selectedStrategy || selectedStrategy.id !== newStrategy.id) {
      setSelectedStrategy(newStrategy);
    }
  }, [selectedStrategy]);
  const [savingsGoal, setSavingsGoal] = useState(null);

  // –ü—Ä–∞–≤–∏–ª–æ 50-25-15-10 Mark Tilbury
  const calculateBudget = (income) => {
    return {
      needs: Math.round(income * 0.50),
      safety: Math.round(income * 0.25),
      investments: Math.round(income * 0.15),
      wants: Math.round(income * 0.10)
    };
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Å–æ–≤–µ—Ç–æ–≤ —Å —É—á—ë—Ç–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  const generateNotifications = (income, budget, strategy, goal) => {
    const notifications = [];

    if (income < 30000) {
      notifications.push({
        id: 1,
        type: 'warning',
        title: t('language') === 'ru' ? '–ù–∏–∑–∫–∏–π –¥–æ—Ö–æ–¥' : 'Low Income',
        message: t('lowIncomeWarning'),
        icon: '‚ö†Ô∏è'
      });
    }

    if (income > 100000) {
      notifications.push({
        id: 2,
        type: 'success',
        title: t('language') === 'ru' ? '–û—Ç–ª–∏—á–Ω—ã–π –¥–æ—Ö–æ–¥!' : 'Great Income!',
        message: t('highIncomeAdvice'),
        icon: 'üí™'
      });
    }

    if (budget.wants > 10000) {
      notifications.push({
        id: 3,
        type: 'danger',
        title: t('language') === 'ru' ? '–ú–Ω–æ–≥–æ —Ç—Ä–∞—Ç –Ω–∞ –∂–µ–ª–∞–Ω–∏—è' : 'High Entertainment Spending',
        message: t('highSpendingWarning'),
        icon: 'üö®'
      });
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    if (strategy) {
      const expectedReturn = getExpectedReturn(strategy.id);
      const yearlyProjection = budget.investments * 12 * (1 + expectedReturn / 100);
      
      notifications.push({
        id: 4,
        type: 'info',
        title: `${t('strategyForecastFor')} ${strategy.title.toLowerCase()}`,
        message: `${t('strategyProjection')} "${strategy.title}" ${t('monthlyInvestment')} ${budget.investments.toLocaleString()} ${t('rubPerMonth')} ~${Math.round(yearlyProjection).toLocaleString()} ${t('rubThroughYear')} (${strategy.expectedReturn}).`,
        icon: strategy.icon
      });

      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ —Ä–∏—Å–∫–∞–º
      if (strategy.id === 'aggressive' && income < 50000) {
        notifications.push({
          id: 5,
          type: 'warning',
          title: t('highRiskLowIncome'),
          message: t('aggressiveRiskWarning'),
          icon: '‚ö†Ô∏è'
        });
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —Ü–µ–ª–∏
    if (goal && budget.safety > 0) {
      const monthsToGoal = Math.ceil((goal.targetAmount - goal.currentAmount) / budget.safety);
      const monthWord = monthsToGoal === 1 ? t('monthWord') : monthsToGoal < 5 ? t('monthsWord2') : t('monthsWord');
      notifications.push({
        id: 6,
        type: 'success',
        title: `${t('savingsProgress')} "${goal.title}"`,
        message: `${t('savingMonthly')} ${budget.safety.toLocaleString()} ${t('achieveGoalInStrategy')} ${monthsToGoal} ${monthWord}!`,
        icon: 'üéØ'
      });
    }

    return notifications;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ–º–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  const getExpectedReturn = (strategyId) => {
    switch (strategyId) {
      case 'conservative': return 6.5; // 5-8% —Å—Ä–µ–¥–Ω–µ–µ 6.5%
      case 'moderate': return 10; // 8-12% —Å—Ä–µ–¥–Ω–µ–µ 10%
      case 'aggressive': return 18; // 12-25% —Å—Ä–µ–¥–Ω–µ–µ 18%
      default: return 10;
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ ID (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å FinancialStrategyCard)
  const createStrategyById = useCallback((strategyId) => {
    const strategiesMap = {
      'conservative': {
        id: 'conservative',
        title: t('conservativeTitle'),
        subtitle: t('conservativeSubtitle'),
        description: t('conservativeDescription'),
        expectedReturn: t('conservativeReturn'),
        riskLevel: t('conservativeRisk'),
        icon: 'üõ°Ô∏è'
      },
      'moderate': {
        id: 'moderate',
        title: t('moderateTitle'),
        subtitle: t('moderateSubtitle'),
        description: t('moderateDescription'),
        expectedReturn: t('moderateReturn'),
        riskLevel: t('moderateRisk'),
        icon: '‚öñÔ∏è'
      },
      'aggressive': {
        id: 'aggressive',
        title: t('aggressiveTitle'),
        subtitle: t('aggressiveSubtitle'),
        description: t('aggressiveDescription'),
        expectedReturn: t('aggressiveReturn'),
        riskLevel: t('aggressiveRisk'),
        icon: 'üöÄ'
      }
    };
    
    return strategiesMap[strategyId] || null;
  }, [t]);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  useEffect(() => {
    if (isAuthenticated && user?.financialData) {
      const data = user.financialData;
      if (data.monthlyIncome) {
        setMonthlyIncome(data.monthlyIncome);
      }
      if (data.budgetDistribution) {
        setBudgetDistribution(data.budgetDistribution);
      }
      if (data.selectedStrategy && (!selectedStrategy || selectedStrategy.id !== data.selectedStrategy)) {
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
        const strategy = createStrategyById(data.selectedStrategy);
        setSelectedStrategy(strategy);
      }
      if (data.savingsGoals && data.savingsGoals.length > 0) {
        setSavingsGoal(data.savingsGoals[0]); // –ü–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–¥–Ω—É —Ü–µ–ª—å
      }
    }
  }, [isAuthenticated, user, selectedStrategy, createStrategyById]); // –î–æ–±–∞–≤–ª—è–µ–º selectedStrategy –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞)
  useEffect(() => {
    if (selectedStrategy?.id) {
      const updatedStrategy = createStrategyById(selectedStrategy.id);
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è (—Å–º–µ–Ω–∞ —è–∑—ã–∫–∞)
      if (updatedStrategy && updatedStrategy.title !== selectedStrategy.title) {
        setSelectedStrategy(updatedStrategy);
      }
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [t, createStrategyById]); // –ù–∞–º–µ—Ä–µ–Ω–Ω–æ –ù–ï –≤–∫–ª—é—á–∞–µ–º selectedStrategy - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞

  useEffect(() => {
    if (monthlyIncome > 0) {
      const budget = calculateBudget(monthlyIncome);
      setBudgetDistribution(budget);
      setNotifications(generateNotifications(monthlyIncome, budget, selectedStrategy, savingsGoal));
      
      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      if (isAuthenticated) {
        saveMonthlyIncome(monthlyIncome, budget);
      }
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [monthlyIncome, selectedStrategy, savingsGoal, isAuthenticated, saveMonthlyIncome]);

  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  useEffect(() => {
    if (selectedStrategy && isAuthenticated) {
      saveStrategy(selectedStrategy);
    }
  }, [selectedStrategy, isAuthenticated, saveStrategy]);

  return (
    <div className="space-y-8 fade-in">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <div className="text-center">
        <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-3 md:mb-4">
          üí∞ {t('financialManagement')}
        </h1>
        <p className="text-base md:text-lg text-gray-600 max-w-2xl mx-auto px-4">
          {t('budgetDistributionRule')} <span className="font-semibold text-primary-600">50-25-15-10</span> {t('fromMarkTilbury')}
        </p>
      </div>

      {/* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –¥–æ—Ö–æ–¥–∞ */}
      <div className="max-w-md mx-auto px-4 md:px-0">
        <IncomeForm 
          monthlyIncome={monthlyIncome}
          setMonthlyIncome={setMonthlyIncome}
        />
      </div>

      {monthlyIncome > 0 && (
        <>
          {/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞ */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 px-2 md:px-0">
            <BudgetRuleCard
              title={t('essentialExpenses')}
              subtitle={`50${t('percentFromIncome')}`}
              amount={budgetDistribution.needs}
              color="bg-gray-500"
              description={t('essentialDesc')}
              icon="üè†"
            />
            <BudgetRuleCard
              title={t('emergencyFund')}
              subtitle={`25${t('percentFromIncome')}`}
              amount={budgetDistribution.safety}
              color="bg-primary-500"
              description={t('emergencyDesc')}
              icon="üõ°Ô∏è"
            />
            <BudgetRuleCard
              title={t('investments')}
              subtitle={selectedStrategy ? `${selectedStrategy.title} ‚Ä¢ 15${t('percentFromIncome')}` : `15${t('percentFromIncome')}`}
              amount={budgetDistribution.investments}
              color="bg-green-500"
              description={selectedStrategy ? `${selectedStrategy.icon} ${selectedStrategy.description}\n${selectedStrategy.expectedReturn}` : t('investmentsDesc')}
              icon={selectedStrategy ? selectedStrategy.icon : "üìà"}
            />
            <BudgetRuleCard
              title={t('entertainment')}
              subtitle={`10${t('percentFromIncome')}`}
              amount={budgetDistribution.wants}
              color="bg-danger-500"
              description={t('entertainmentDesc')}
              icon="üéâ"
            />
          </div>

          {/* –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è */}
          <FinancialStrategyCard
            selectedStrategy={selectedStrategy}
            onStrategyChange={handleStrategyChange}
          />

          {/* –¶–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è */}
          <SavingsGoalCard
            goal={savingsGoal}
            onGoalChange={setSavingsGoal}
            monthlyBudget={budgetDistribution}
          />

          {/* –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è */}
          <div className="max-w-2xl mx-auto">
            <div className="card">
              <h3 className="text-xl font-semibold text-gray-900 mb-4 text-center">
                {t('budgetVisualization')}
              </h3>
              <BudgetChart budgetDistribution={budgetDistribution} />
            </div>
          </div>

          {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ */}
          {notifications.length > 0 && (
            <div className="space-y-4">
              <h3 className="text-xl font-semibold text-gray-900 text-center">
                üí° {t('personalRecommendations')}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {notifications.map((notification) => (
                  <NotificationCard key={notification.id} notification={notification} />
                ))}
              </div>
            </div>
          )}

          {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
          <div className="card bg-gradient-to-r from-primary-50 to-blue-50 border-primary-200">
            <div className="text-center">
              <h3 className="text-lg font-semibold text-primary-900 mb-2">
                üéØ –ü—Ä–∞–≤–∏–ª–æ 50-25-15-10 –æ—Ç Mark Tilbury
              </h3>
              <p className="text-primary-700 text-sm">
                –≠—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –≤—Ä–µ–º–µ–Ω–µ–º —Ñ–æ—Ä–º—É–ª–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —É—Å–ø–µ—Ö–∞. –°–ª–µ–¥—É—è —ç—Ç–æ–º—É –ø—Ä–∞–≤–∏–ª—É, 
                –≤—ã –æ–±–µ—Å–ø–µ—á–∏—Ç–µ —Å–µ–±–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å–æ–∑–¥–∞–¥–∏—Ç–µ –∫–∞–ø–∏—Ç–∞–ª –¥–ª—è –±—É–¥—É—â–µ–≥–æ.
              </p>
              <div className="mt-4 flex justify-center space-x-4 text-xs text-primary-600">
                <span>‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –Ω—É–∂–¥</span>
                <span>‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–¥—É—à–∫–∞</span>
                <span>‚úÖ –†–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞</span>
                <span>‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏</span>
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  );
} 